<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <title>Disaster Detection</title>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
        background: black;
      }
      video,
      canvas,
      img {
        max-width: 85vw;
      }
      #container {
        position: relative;
        display: inline-block;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
      }
      h1 {
        color: white;
        margin-bottom: 0;
      }
      button {
        margin-top: 23px;
        font-size: 18px;
        height: 38px;
        width: 210px;
        background-color: black;
        border: 1px solid white;
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }
      .head {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }
      input[type="file"] {
        appearance: none;
        -webkit-appearance: none;
        margin-top: 23px;
        font-size: 18px;
        height: 28px;
        width: 210px;
        background-color: black;
        border: 1px solid white;
        color: white;
        text-align: center;
        padding: 5px 0;
        border-radius: 5px;
        cursor: pointer;
      }
      input[type="file"]::-webkit-file-upload-button {
        visibility: hidden;
      }
      input[type="file"]::before {
        content: "Upload File";
        display: inline-block;
        font-size: 18px;
        color: white;
        background: black;
        width: 100%;
        text-align: center;
        cursor: pointer;
      }
      input[type="file"]:nth-of-type(1)::before {
        content: "Upload Video";
      }
      input[type="file"]:nth-of-type(2)::before {
        content: "Upload Image";
      }
      h2 {
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="head">
      <h1>Disaster Detection</h1>
      <button onclick="startWebcam()">Use Webcam</button>
      <input type="file" accept="video/*" onchange="loadVideo(event)" />
      <input type="file" accept="image/*" onchange="loadImage(event)" />
    </div>

    <h2 id="counterText">
      Log Counter (Fire: 0üî• Smoke: 0üö¨ Person: 0üßî Drowning: 0üíß Landslide:
      0‚ùå)
    </h2>

    <div id="container">
      <video id="video" autoplay muted playsinline></video>
      <img id="uploadedImage" style="display: none" />
      <canvas id="overlay"></canvas>
    </div>
  </body>

  <script>
    const API_KEY = "8Mo9AvTEN1lIfRiLfdkF";
    const API_URL =
      "https://serverless.roboflow.com/disasterdetection2-wyfhe/2";

    const video = document.getElementById("video");
    const img = document.getElementById("uploadedImage");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");

    let running = false;

    let counter = {
      fire: 0,
      smoke: 0,
      person: 0,
      drowning: 0,
      landslide: 0,
    };

    function updateCounterDisplay() {
      document.getElementById(
        "counterText"
      ).innerText = `Log Counter (Fire: ${counter.fire}üî•  Smoke: ${counter.smoke}üö¨  Person: ${counter.person}üßî  Drowning: ${counter.drowning}üíß  Landslide: ${counter.landslide}‚ö†)`;
    }

    async function startWebcam() {
      img.style.display = "none";
      video.style.display = "block";
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        running = true;
        detectFrame();
      };
    }

    function loadVideo(e) {
      img.style.display = "none";
      video.style.display = "block";
      running = true;
      const file = e.target.files[0];
      if (!file) return;
      video.src = URL.createObjectURL(file);
      video.loop = true;
      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        detectFrame();
      };
    }

    function loadImage(e) {
      running = false;
      video.style.display = "none";
      img.style.display = "block";
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        img.src = reader.result;
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          detectOnCanvas(img);
        };
      };
      reader.readAsDataURL(file);
    }

    async function detectFrame() {
      if (!running) return;
      if (video.paused || video.ended) {
        requestAnimationFrame(detectFrame);
        return;
      }
      detectOnCanvas(video);
      setTimeout(() => requestAnimationFrame(detectFrame), 200);
    }

    async function detectOnCanvas(source) {
      const temp = document.createElement("canvas");
      temp.width = source.width || source.videoWidth;
      temp.height = source.height || source.videoHeight;
      const tctx = temp.getContext("2d");
      tctx.drawImage(source, 0, 0, temp.width, temp.height);
      const base64 = temp.toDataURL("image/jpeg").split(",")[1];
      try {
        const data = await detectDisaster(base64);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBoxes(data);
      } catch (err) {
        console.log("Detection Error:", err);
      }
    }

    async function detectDisaster(image) {
      const response = await fetch(`${API_URL}?api_key=${API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: image,
      });
      return await response.json();
    }

    function drawBoxes(data) {
      if (!data.predictions) return;

      data.predictions.forEach((p) => {
        if (p.class === "fire") counter.fire++;
        if (p.class === "smoke" && p.confidence >= 0.9) counter.smoke++;
        if (p.class === "person") counter.person++;
        if (p.class === "drowning") counter.drowning++;
        if (p.class === "landslide") counter.landslide++;
      });

      updateCounterDisplay();

      data.predictions.forEach((p) => {
        if (p.class === "smoke" && p.confidence < 0.9) return;

        const x = p.x - p.width / 2;
        const y = p.y - p.height / 2;

        let color = "#ffff00";
        if (p.class === "person") color = "#6d80fa";
        if (p.class === "fire") color = "#ff0000";
        if (p.class === "smoke") color = "#8a8a8a";

        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, p.width, p.height);

        ctx.fillStyle = color;
        ctx.font = "20px Arial";
        ctx.fillText(
          `${p.class} (${(p.confidence * 100).toFixed(1)}%)`,
          x,
          y - 5
        );
      });
    }
  </script>
</html>
