<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <title>Fire detection</title>
    <style>
      body {
        font-family: "Montserrat", sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
        background: black;
      }
      video,
      canvas {
        max-width: 85vw;
      }
      #container {
        position: relative;
        display: inline-block;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
      }
      h1 {
        color: white;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      button,
      input[type="file"] {
        margin-top: 23px;
        padding-top: 0px;
        font-size: 18px;
        align-items: center;
        height: 28px;
        width: 200px;
        background-color: black;
        border: 1px solid white;
        color: white;
        border-radius: 5px;
      }

      .head {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="head">
      <h1>Fire Detection</h1>
      <button onclick="startWebcam()">Use Webcam</button>
      <input type="file" accept="video/*" onchange="loadVideo(event)" />
    </div>
    <div id="container">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>
  </body>
  <script>
    const API_KEY = "wc7Qma2sHvvRwnzqywCq";
    const MODEL_ID = "fire_detection-uhbdr/3";
    const API_URL = `https://serverless.roboflow.com/${MODEL_ID}`;

    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");

    let running = false;

    async function startWebcam() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
      });
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        running = true;
        detectFrame();
      };
    }

    function loadVideo(e) {
      const file = e.target.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      video.src = url;
      video.loop = true;

      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        running = true;
        detectFrame();
      };
    }
    async function detectFrame() {
      if (!running) return;

      if (video.paused || video.ended) {
        requestAnimationFrame(detectFrame);
        return;
      }

      const temp = document.createElement("canvas");
      temp.width = video.videoWidth;
      temp.height = video.videoHeight;
      const tctx = temp.getContext("2d");
      tctx.drawImage(video, 0, 0, temp.width, temp.height);

      const base64 = temp.toDataURL("image/jpeg").split(",")[1];

      try {
        const res = await fetch(`${API_URL}?api_key=${API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: base64,
        });

        const data = await res.json();
        drawResults(data);
      } catch (err) {
        console.log("Error:", err);
      }

      setTimeout(() => requestAnimationFrame(detectFrame), 200);
    }

    function drawResults(data) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (!data.predictions) return;

      data.predictions.forEach((p) => {
        const x = p.x - p.width / 2;
        const y = p.y - p.height / 2;

        ctx.strokeStyle = "red";
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, p.width, p.height);

        ctx.fillStyle = "red";
        ctx.font = "20px Arial";
        ctx.fillText(
          `${p.class} (${(p.confidence * 100).toFixed(1)}%)`,
          x,
          y > 20 ? y - 5 : y + 20
        );
      });
    }
  </script>
</html>
