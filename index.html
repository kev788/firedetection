<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <title>Disaster Detection</title>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
        background: black;
      }
      video,
      canvas {
        max-width: 85vw;
      }
      #container {
        position: relative;
        display: inline-block;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
      }
      h1 {
        color: white;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      button,
      input[type="file"] {
        margin-top: 23px;
        padding-top: 0px;
        font-size: 18px;
        align-items: center;
        height: 28px;
        width: 200px;
        background-color: black;
        border: 1px solid white;
        color: white;
        border-radius: 5px;
      }

      .head {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      #alertBox {
        display: none;
        background: red;
        color: white;
        padding: 12px 20px;
        font-size: 20px;
        font-weight: 700;
        position: fixed;
        top: 10px;
        left: 10px;
        border-radius: 6px;
        z-index: 9999;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
      }
    </style>
  </head>

  <body>
    <div id="alertBox"></div>

    <div class="head">
      <h1>Fire & Landslide Detection</h1>
      <button onclick="startWebcam()">Use Webcam</button>
      <input type="file" accept="video/*" onchange="loadVideo(event)" />
    </div>

    <div id="container">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>
  </body>

  <script>
    const FIRE_API_KEY = "wc7Qma2sHvvRwnzqywCq";
    const FIRE_API_URL =
      "https://serverless.roboflow.com/fire_detection-uhbdr/3";

    const LANDSLIDE_API_KEY = "wc7Qma2sHvvRwnzqywCq";
    const LANDSLIDE_API_URL =
      "https://serverless.roboflow.com/landslide_segmentation-vhobb/3";

    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const alertBox = document.getElementById("alertBox");

    let running = false;
    let alertActive = false; 

    function showAlert(message) {
      if (alertActive) return;

      alertActive = true;
      alertBox.innerText = message;
      alertBox.style.display = "block";
    }

    async function startWebcam() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        running = true;
        detectFrame();
      };
    }

    function loadVideo(e) {
      const file = e.target.files[0];
      if (!file) return;

      video.src = URL.createObjectURL(file);
      video.loop = true;

      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        running = true;
        detectFrame();
      };
    }
    async function detectFrame() {
      if (!running) return;

      if (video.paused || video.ended) {
        requestAnimationFrame(detectFrame);
        return;
      }

      const temp = document.createElement("canvas");
      temp.width = video.videoWidth;
      temp.height = video.videoHeight;

      const tctx = temp.getContext("2d");
      tctx.drawImage(video, 0, 0, temp.width, temp.height);

      const base64 = temp.toDataURL("image/jpeg").split(",")[1];

      try {
        const [fireData, landslideData] = await Promise.all([
          detectFire(base64),
          detectLandslide(base64),
        ]);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawBoxes(fireData, "fire");
        drawBoxes(landslideData, "landslide");
      } catch (err) {
        console.log("Detection Error:", err);
      }

      setTimeout(() => requestAnimationFrame(detectFrame), 200);
    }

    async function detectFire(image) {
      const response = await fetch(`${FIRE_API_URL}?api_key=${FIRE_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: image,
      });

      const data = await response.json();

      if (data.predictions?.length > 0) {
        showAlert("ðŸ”¥ Fire Detected");
      }

      return data;
    }

    async function detectLandslide(image) {
      const response = await fetch(
        `${LANDSLIDE_API_URL}?api_key=${LANDSLIDE_API_KEY}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: image,
        }
      );

      const data = await response.json();

      if (data.predictions?.length > 0) {
        showAlert("â›°ï¸ Landslide Detected");
      }

      return data;
    }

    function drawBoxes(data, type) {
      if (!data.predictions) return;

      data.predictions.forEach((p) => {
        const x = p.x - p.width / 2;
        const y = p.y - p.height / 2;

        ctx.strokeStyle = type === "fire" ? "red" : "blue";
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, p.width, p.height);

        ctx.fillStyle = type === "fire" ? "red" : "blue";
        ctx.font = "20px Arial";
        ctx.fillText(
          `${p.class} (${(p.confidence * 100).toFixed(1)}%)`,
          x,
          y - 5
        );
      });
    }
  </script>
</html>
